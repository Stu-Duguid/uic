/*!
 * Copyright (c) 2025 Acoustic, L.P. All rights reserved.
 *
 * NOTICE: This file contains material that is confidential and proprietary to
 * Acoustic, L.P. and/or other developers. No license is granted under any intellectual or
 * industrial property rights of Acoustic, L.P. except as may be provided in an agreement with
 * Acoustic, L.P. Any unauthorized copying or distribution of content from this file is
 * prohibited.
 *
 * README
 * https://github.com/acoustic-analytics/UICaptureSDK-Modules/blob/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(e){"use strict";function t(e){function t(e,t){for(var n=o.length;n>0;){if(n-=1,o[n]===e)return"XXXXX";if(o[n].cRegex&&o[n].cRegex.test(e))return"XXXXX"}return t}function n(e){var n;try{n=JSON.stringify(e,t)}catch(e){return"Error applying Ajax Listener privacy - "+e.message}return JSON.parse(n)}var r,s=e.customEvent.data,a=X.blockNonJSONResponse||!1,o=X.fieldBlocklist||[];return 0!==s.length&&(a&&(r=s.responseHeaders["content-type"],void 0!==r&&-1!==r.indexOf("application/json")||(s.response="non-JSON data has been masked")),e.customEvent.data=n(s)),e}function n(e){var t,n,r,s=!1,a=X.urlBlocklist;if(!e||!a)return s;for(t=0,n=a.length;!s&&t<n;t+=1)r=a[t],s=r.cRegex.test(e);return s}function r(e,t,n){var r,s,a,o={},i=X.filters;if(!i||!i.length)return o;for(r=0,s=i.length,a=!1;!a&&r<s;r+=1)o=i[r],a=!0,o.url&&(a=o.url.cRegex.test(e)),a&&o.method&&(a=o.method.cRegex.test(t)),a&&o.status&&(a=o.status.cRegex.test(n));return a||(o=null),o}function s(e){var t,n,r,s,a,o={};for(e=e.split(/[\r\n]+/),t=0,n=e.length;t<n;t+=1)r=e[t].split(": "),s=r[0],a=T.rtrim(r[1]),s&&s.length&&(o[s]=a);return o}function a(n,r){var a,o,i={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"XHR"}}},u=i.customEvent.data;if(n){if(a=document.createElement("a"),a.href=n.tListener.url,u.originalURL=a.host+("/"===a.pathname[0]?"":"/")+a.pathname,u.requestURL=e.normalizeUrl?e.normalizeUrl(u.originalURL,3):u.originalURL,u.description="Full Ajax Monitor "+u.requestURL,u.method=n.tListener.method,u.status=n.status,u.statusText=n.statusText||"",u.async=n.tListener.async,u.ajaxResponseTime=n.tListener.end-n.tListener.start,u.locationHref=e.normalizeUrl(document.location.href,3),r.requestHeaders&&(u.requestHeaders=n.tListener.reqHeaders),r.requestData&&"string"==typeof n.tListener.reqData&&!n.tListener.isSystemXHR)try{u.request=JSON.parse(n.tListener.reqData)}catch(e){u.request=n.tListener.reqData}if(r.responseHeaders&&(u.responseHeaders=s(n.getAllResponseHeaders())),r.responseData){if(void 0===n.responseType?o=n.responseText:""===n.responseType||"text"===n.responseType?o=n.response:"json"===n.responseType?u.response=n.response:u.response=typeof n.response,o)try{u.response=JSON.parse(o)}catch(e){u.response=o}n.responseType&&(u.responseType=n.responseType)}i=t(i),e.post(i)}}function o(e){for(var t,n={},r=e.entries(),s=r.next();!s.done;)t=s.value,n[t[0]]=t[1],s=r.next();return n}function i(e){return o(e)}function u(e){var t=e;if(!e)return t;if("object"==typeof e&&-1!==e.toString().indexOf("FormData"))t=o(e);else if("string"==typeof e)try{t=JSON.parse(e)}catch(n){t=e}return t}function c(n,r,s){var a,o,c={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"fetch"}}},p=c.customEvent.data;if(a=document.createElement("a"),a.href=n.url,p.originalURL=a.host+("/"===a.pathname[0]?"":"/")+a.pathname,p.requestURL=e.normalizeUrl?e.normalizeUrl(p.originalURL,3):p.originalURL,p.description="Full Ajax Monitor "+p.requestURL,p.method=n.initData.method,p.status=r.status,p.statusText=r.statusText||"",p.async=!0,p.ajaxResponseTime=n.end-n.start,p.responseType=r.type,p.locationHref=e.normalizeUrl(document.location.href,3),s.requestHeaders&&(n.initData.headers&&-1!==n.initData.headers.toString().indexOf("Headers")?p.requestHeaders=i(n.initData.headers):p.requestHeaders=n.initData.headers||""),s.requestData&&void 0!==n.body&&!n.isSystemXHR&&(p.request=u(n.body)),s.responseHeaders&&(p.responseHeaders=i(r.headers)),s.responseData){if(o=r.headers.get("content-type"),o&&-1!==o.indexOf("application/json"))return void r.clone().json().then(function(n){p.response=n,c=t(c),e.post(c)});if(o&&(-1!==o.indexOf("text")||-1!==o.indexOf("xml")))return void r.clone().text().then(function(n){p.response=n,c=t(c),e.post(c)});p.response="Not logging unsupported response content: "+o}c=t(c),e.post(c)}function p(e){var t,n=e.tListener.url,s=e.tListener.method,o=e.status.toString(),i={requestHeaders:!1,requestData:!1,responseHeaders:!1,responseData:!1};t=r(n,s,o),t&&(t.log&&(i=t.log),a(e,i))}function d(e,t){var s,a=e.url,o=e.initData.method,i=t.status.toString(),u={requestHeaders:!1,requestData:!1,responseHeaders:!1,responseData:!1};n(a)||(s=r(a,o,i),s&&(s.log&&(u=s.log),c(e,t,u)))}function l(e){var t,n;e&&e.target&&(t=e.target,n=t.readyState,4===n&&(t.removeEventListener("readystatechange",l),t.tListener.end=Date.now(),p(t)))}function f(e){var t=e.setRequestHeader;e.setRequestHeader=function(e,n){var r=this,s=r.tListener;return e&&e.length&&(s.reqHeaders[e]=n),t.apply(r,arguments)}}function h(e){var t=e.send;e.send=function(e){var n=this,r=n.tListener;return e&&(r.reqData=e),r.start=Date.now(),t.apply(n,arguments)}}function g(e){var t,n,r;for(n=TLT.getServiceConfig("queue"),r=n.queues||[],t=0;t<r.length;t+=1)if(r[t].endpoint&&-1!==e.indexOf(r[t].endpoint))return!0;return!1}function y(e,t,r){var s=this;return S&&!n(t)&&(s.addEventListener("readystatechange",l),s.tListener={method:e,url:t,async:void 0===r||!!r,reqHeaders:{},isSystemXHR:g(t)},f(s),h(s)),q.apply(s,arguments)}function m(){XMLHttpRequest&&(q=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=y)}function v(){R=window.fetch,window.fetch=function(e,t){var n,r={};return"object"==typeof e?(r.initData=e,r.url=e.url,r.initData.clone().text().then(function(e){e.length>0&&(r.body=e)})):(r.initData=t||{},r.url=e,t&&t.body&&(r.body=t.body)),r.isSystemXHR=g(r.url),r.start=Date.now(),n=R.apply(this,arguments),n.then(function(e){return r.end=Date.now(),d(r,e),e})}}function x(e){e&&e.regex&&(e.cRegex=new RegExp(e.regex,e.flags))}function L(e){var t,n,r,s=[],a=T.getValue(e,"skipSafetyCheck",!1);for(e&&e.filters&&(s=e.filters),t=0,n=s.length;t<n;t+=1)r=s[t],T.forEach([r.url,r.method,r.status],x);e&&e.urlBlocklist&&T.forEach(e.urlBlocklist,x),e&&e.fieldBlocklist&&T.forEach(e.fieldBlocklist,x),H=T.getValue(e,"xhrEnabled",!0)&&window.XMLHttpRequest,!H||a||-1!==XMLHttpRequest.toString().indexOf("[native code]")&&-1!==XMLHttpRequest.toString().indexOf("XMLHttpRequest")||(H=!1),D=T.getValue(e,"fetchEnabled",!0)&&window.fetch,D&&!a&&-1===window.fetch.toString().indexOf("[native code]")&&(D=!1)}var q,R,H,D,X={},S=!1,T=e.utils;return{init:function(){X=e.getConfig(),L(X)},destroy:function(){S=!1},onevent:function(e){switch(e.type){case"load":H&&m(),D&&v(),S=!0;break;case"pagehide":S=!1}},version:"1.3.3"}});