/*!
 * Copyright (c) 2021 Acoustic, L.P. All rights reserved.
 *
 * NOTICE: This file contains material that is confidential and proprietary to
 * Acoustic, L.P. and/or other developers. No license is granted under any intellectual or
 * industrial property rights of Acoustic, L.P. except as may be provided in an agreement with
 * Acoustic, L.P. Any unauthorized copying or distribution of content from this file is
 * prohibited.
 *
 * README
 * https://github.com/acoustic-analytics/UICaptureSDK-Modules/blob/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(e){"use strict";function t(e){var t,n,r,s=!1,a=D.urlBlocklist;if(!e||!a)return s;for(t=0,n=a.length;!s&&t<n;t+=1)r=a[t],s=r.cRegex.test(e);return s}function n(e,t,n){var r,s,a,o={},i=D.filters;if(!i||!i.length)return o;for(r=0,s=i.length,a=!1;!a&&r<s;r+=1)o=i[r],a=!0,o.url&&(a=o.url.cRegex.test(e)),a&&o.method&&(a=o.method.cRegex.test(t)),a&&o.status&&(a=o.status.cRegex.test(n));return a||(o=null),o}function r(e){var t,n,r,s,a,o={};for(e=e.split(/[\r\n]+/),t=0,n=e.length;t<n;t+=1)r=e[t].split(": "),s=r[0],a=S.rtrim(r[1]),s&&s.length&&(o[s]=a);return o}function s(t,n){var s,a,o={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"XHR"}}},i=o.customEvent.data;if(t){if(s=document.createElement("a"),s.href=t.tListener.url,i.originalURL=s.host+("/"===s.pathname[0]?"":"/")+s.pathname+s.search+s.hash,i.requestURL=e.normalizeUrl?e.normalizeUrl(i.originalURL,3):i.originalURL,i.description="Full Ajax Monitor "+s.host+s.pathname,i.method=t.tListener.method,i.status=t.status,i.statusText=t.statusText||"",i.async=t.tListener.async,i.ajaxResponseTime=t.tListener.end-t.tListener.start,i.locationHref=e.normalizeUrl(document.location.href,3),n.requestHeaders&&(i.requestHeaders=t.tListener.reqHeaders),n.requestData&&"string"==typeof t.tListener.reqData&&!t.tListener.isSystemXHR)try{i.request=JSON.parse(t.tListener.reqData)}catch(e){i.request=t.tListener.reqData}if(n.responseHeaders&&(i.responseHeaders=r(t.getAllResponseHeaders())),n.responseData){if(void 0===t.responseType?a=t.responseText:""===t.responseType||"text"===t.responseType?a=t.response:"json"===t.responseType?i.response=t.response:i.response=typeof t.response,a)try{i.response=JSON.parse(a)}catch(e){i.response=a}t.responseType&&(i.responseType=t.responseType)}e.post(o)}}function a(e){for(var t,n={},r=e.entries(),s=r.next();!s.done;)t=s.value,n[t[0]]=t[1],s=r.next();return n}function o(e){return a(e)}function i(e){var t=e;if(!e)return t;if("object"==typeof e&&-1!==e.toString().indexOf("FormData"))t=a(e);else if("string"==typeof e)try{t=JSON.parse(e)}catch(n){t=e}return t}function u(t,n,r){var s,a,u={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"fetch"}}},p=u.customEvent.data;if(s=document.createElement("a"),s.href=t.url,p.originalURL=s.host+("/"===s.pathname[0]?"":"/")+s.pathname,p.requestURL=e.normalizeUrl?e.normalizeUrl(p.originalURL,3):p.originalURL,p.description="Full Ajax Monitor "+p.requestURL,p.method=t.initData.method,p.status=n.status,p.statusText=n.statusText||"",p.async=!0,p.ajaxResponseTime=t.end-t.start,p.responseType=n.type,p.locationHref=e.normalizeUrl(document.location.href,3),r.requestHeaders&&(t.initData.headers&&-1!==t.initData.headers.toString().indexOf("Headers")?p.requestHeaders=o(t.initData.headers):p.requestHeaders=t.initData.headers||""),r.requestData&&void 0!==t.body&&!t.isSystemXHR&&(p.request=i(t.body)),r.responseHeaders&&(p.responseHeaders=o(n.headers)),r.responseData){if(a=n.headers.get("content-type"),a&&-1!==a.indexOf("application/json"))return void n.clone().json().then(function(t){p.response=t,e.post(u)});if(a&&(-1!==a.indexOf("text")||-1!==a.indexOf("xml")))return void n.clone().text().then(function(t){p.response=t,e.post(u)});p.response="Not logging unsupported response content: "+a}e.post(u)}function p(e){var t,r=e.tListener.url,a=e.tListener.method,o=e.status.toString(),i={requestHeaders:!1,requestData:!1,responseHeaders:!1,responseData:!1};t=n(r,a,o),t&&(t.log&&(i=t.log),s(e,i))}function d(e,r){var s,a=e.url,o=e.initData.method,i=r.status.toString(),p={requestHeaders:!1,requestData:!1,responseHeaders:!1,responseData:!1};t(a)||(s=n(a,o,i),s&&(s.log&&(p=s.log),u(e,r,p)))}function c(e){var t,n;e&&e.target&&(t=e.target,n=t.readyState,4===n&&(t.removeEventListener("readystatechange",c),t.tListener.end=Date.now(),p(t)))}function l(e){var t=e.setRequestHeader;e.setRequestHeader=function(e,n){var r=this,s=r.tListener;return e&&e.length&&(s.reqHeaders[e]=n),t.apply(r,arguments)}}function f(e){var t=e.send;e.send=function(e){var n=this,r=n.tListener;return e&&(r.reqData=e),r.start=Date.now(),t.apply(n,arguments)}}function h(e){var t,n,r;for(n=TLT.getServiceConfig("queue"),r=n.queues||[],t=0;t<r.length;t+=1)if(r[t].endpoint&&-1!==e.indexOf(r[t].endpoint))return!0;return!1}function g(e,n,r){var s=this;return T&&!t(n)&&(s.addEventListener("readystatechange",c),s.tListener={method:e,url:n,async:void 0===r||!!r,reqHeaders:{},isSystemXHR:h(n)},l(s),f(s)),x.apply(s,arguments)}function y(){XMLHttpRequest&&(x=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=g)}function m(){q=window.fetch,window.fetch=function(e,t){var n,r={};return"object"==typeof e?(r.initData=e,r.url=e.url,r.initData.clone().text().then(function(e){e.length>0&&(r.body=e)})):(r.initData=t||{},r.url=e,t&&t.body&&(r.body=t.body)),r.isSystemXHR=h(r.url),r.start=Date.now(),n=q.apply(this,arguments),n.then(function(e){return r.end=Date.now(),d(r,e),e})}}function L(e){e&&e.regex&&(e.cRegex=new RegExp(e.regex,e.flags))}function v(e){var t,n,r,s=[],a=S.getValue(e,"skipSafetyCheck",!1);for(e&&e.filters&&(s=e.filters),t=0,n=s.length;t<n;t+=1)r=s[t],S.forEach([r.url,r.method,r.status],L);e&&e.urlBlocklist&&S.forEach(e.urlBlocklist,L),H=S.getValue(e,"xhrEnabled",!0)&&window.XMLHttpRequest,!H||a||-1!==XMLHttpRequest.toString().indexOf("[native code]")&&-1!==XMLHttpRequest.toString().indexOf("XMLHttpRequest")||(H=!1),R=S.getValue(e,"fetchEnabled",!0)&&window.fetch,R&&!a&&-1===window.fetch.toString().indexOf("[native code]")&&(R=!1)}var x,q,H,R,D={},T=!1,S=e.utils;return{init:function(){D=e.getConfig(),v(D)},destroy:function(){T=!1},onevent:function(e){switch(e.type){case"load":H&&y(),R&&m(),T=!0;break;case"unload":T=!1}},version:"1.3.0"}});